extends ../layout

block content
  .container-fluid.px-4
    .d-flex.justify-content-between.align-items-center.mb-4
      h1.mb-0 Asset Inventory
      .btn-group
        a.btn.btn-primary(href='/assets/add')
          i.fas.fa-plus.me-2
          | Add New Asset
        a.btn.btn-success(href='/asset-assignments/issue')
          i.fas.fa-hand-holding-box.me-2
          | Issue Asset
        a.btn.btn-warning(href='/asset-assignments/return')
          i.fas.fa-undo.me-2
          | Return Asset
        a.btn.btn-danger(href='/asset-assignments/scrap')
          i.fas.fa-trash.me-2
          | Scrap Asset
    
    // Filter Section
    .card.mb-4
      .card-header
        i.fas.fa-filter.me-1
        | Filters
      .card-body
        // Filter form with multiple search
        form#assetFilterForm.row.g-3(method='GET', action='/assets')
          .col-md-2
            label.form-label Search
            input#searchInput.form-control(type='text', name='search', value=searchQuery, placeholder='Search assets...')
          // Category filter dropdown
          .col-md-2
            label.form-label Category
            select#categoryFilter.form-select(name='category')
              option(value='') All Categories
              each category in categories
                option(value=category.id, selected=selectedCategory == category.id)= category.name
          // Status filter dropdown
          .col-md-2
            label.form-label Status
            select#statusFilter.form-select(name='status')
              option(value='') All Status
              each status in statuses
                option(value=status, selected=selectedStatus == status)= status.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
          // Branch filter dropdown
          .col-md-2
            label.form-label Branch
            select#branchFilter.form-select(name='branch')
              option(value='') All Branches
              each branch in branches
                option(value=branch, selected=selectedBranch == branch)= branch
          // Sort by dropdown
          .col-md-2
            label.form-label Sort By
            select#sortBy.form-select(name='sortBy')
              option(value='name', selected=sortBy === 'name') Name
              option(value='asset_tag', selected=sortBy === 'asset_tag') Asset Tag
              option(value='purchase_date', selected=sortBy === 'purchase_date') Purchase Date
              option(value='purchase_cost', selected=sortBy === 'purchase_cost') Cost
              option(value='status', selected=sortBy === 'status') Status
          // Sort order dropdown
          .col-md-2
            label.form-label Order
            select#sortOrder.form-select(name='sortOrder')
              option(value='ASC', selected=sortOrder === 'ASC') A-Z
              option(value='DESC', selected=sortOrder === 'DESC') Z-A
          // Filter action buttons
          .col-12
            button.btn.btn-primary.me-2(type='submit') Apply Filters
            a.btn.btn-outline-secondary(href='/assets') Clear All
    
    .card.mb-4
      .card-header.d-flex.justify-content-between.align-items-center
        div
          i.fas.fa-table.me-1
          | Assets List
        // Export dropdown menu for pdf , csv and excel export 
        .dropdown
          button.btn.btn-sm.btn-outline-secondary.dropdown-toggle(type='button', id='exportDropdown', data-bs-toggle='dropdown', aria-expanded='false')
            i.fas.fa-download.me-1
            | Export
          ul.dropdown-menu.dropdown-menu-end(aria-labelledby='exportDropdown')
            li
              a.dropdown-item(href='#', data-export='csv') CSV
            li
              a.dropdown-item(href='#', data-export='excel') Excel
            li
              a.dropdown-item(href='#', data-export='pdf') PDF
      .card-body
        .table-responsive
          table#assetsTable.table.table-striped.table-hover.table-bordered
            thead.table-light
              tr
                th Asset Tag
                th Name
                th Category
                th Serial Number
                th Purchase Date
                th Purchase Cost
                th Status
                th Assigned To
                th Actions
            tbody
              each asset in assets
                tr
                  td= asset.asset_tag || 'N/A'
                  td
                    a(href=`/assets/${asset.id}`)= asset.name
                  td= asset.Category ? asset.Category.name : 'Uncategorized'
                  td= asset.serial_number || 'N/A'
                  td= asset.purchase_date ? new Date(asset.purchase_date).toLocaleDateString() : 'N/A'
                  td= asset.purchase_cost ? `â‚¹${parseFloat(asset.purchase_cost).toFixed(2)}` : 'N/A'
                  td
                    span.badge.rounded-pill(class={
                      'bg-success': asset.status === 'available',
                      'bg-primary': asset.status === 'assigned',
                      'bg-warning': asset.status === 'under_maintenance',
                      'bg-secondary': asset.status === 'retired'
                    })= asset.status.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
                  // Assigned to column
                  td
                    if asset.Assignments && asset.Assignments.length > 0 && asset.Assignments[0].employee
                      - const employee = asset.Assignments[0].employee;
                      = `${employee.first_name} ${employee.last_name} (${employee.employee_id})`
                    else
                      | Unassigned
                  // Actions columns with view, edit, and delete buttons
                  td
                    .btn-group.btn-group-sm(role='group')
                      a.btn.btn-outline-primary(href=`/assets/${asset.id}` title='View')
                        i.fas.fa-eye
                      a.btn.btn-outline-secondary(href=`/assets/edit/${asset.id}` title='Edit')
                        i.fas.fa-edit
                      button.btn.btn-outline-danger.delete-asset(type='button' data-id=asset.id title='Delete')
                        i.fas.fa-trash
    
    // Pagination
    if totalPages > 1
      .d-flex.justify-content-between.align-items-center
        // Shows current page information
        span.text-muted Showing #{(currentPage - 1) * limit + 1} to #{Math.min(currentPage * limit, totalCount)} of #{totalCount} assets
        // Pagination navigation
        nav
          ul.pagination.mb-0
            // Previous page button
            li.page-item(class=currentPage === 1 ? 'disabled' : '')
              a.page-link(href=`?page=${currentPage - 1}&search=${searchQuery}&category=${selectedCategory}&status=${selectedStatus}&branch=${selectedBranch}&sortBy=${sortBy}&sortOrder=${sortOrder}`) Previous
            // Page number button
            - for(var i = 1; i <= totalPages; i++)
              li.page-item(class=i === currentPage ? 'active' : '')
                a.page-link(href=`?page=${i}&search=${searchQuery}&category=${selectedCategory}&status=${selectedStatus}&branch=${selectedBranch}&sortBy=${sortBy}&sortOrder=${sortOrder}`)= i
            // Next page button 
            li.page-item(class=currentPage === totalPages ? 'disabled' : '')
              a.page-link(href=`?page=${currentPage + 1}&search=${searchQuery}&category=${selectedCategory}&status=${selectedStatus}&branch=${selectedBranch}&sortBy=${sortBy}&sortOrder=${sortOrder}`) Next
    
    // Delete Confirmation Modal 
    #deleteAssetModal.modal.fade(tabindex='-1')
      .modal-dialog
        .modal-content
          .modal-header.bg-danger.text-white
            h5.modal-title Confirm Deletion
            button.btn-close.btn-close-white(type='button' data-bs-dismiss='modal' aria-label='Close')
          .modal-body
            p Are you sure you want to delete this asset?
            p.text-danger This action cannot be undone.
          .modal-footer.d-flex.justify-content-center
            button.btn.btn-outline-secondary.me-2(type='button' data-bs-dismiss='modal')
              i.fas.fa-times.me-1
              | Cancel
            button#confirmDelete.btn.btn-danger(type='button')
              i.fas.fa-trash-alt.me-1
              | Delete Permanently
    
    // Js for interactive 
    block scripts
      script.
        document.addEventListener('DOMContentLoaded', function() {
          // Initialize DataTable 
          if (!$.fn.DataTable.isDataTable('#assetsTable')) {
            const table = $('#assetsTable').DataTable({
              pageLength: 10
            });
          }
          
          // Export functionality for pdf generation
          document.querySelectorAll('[data-export]').forEach(item => {
            item.addEventListener('click', function(e) {
              e.preventDefault();
              const exportType = this.dataset.export;
              const table = $('#assetsTable').DataTable();
              
              if (exportType === 'pdf') {
                // Custom PDF export using jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape', 'mm', 'a4');
                
                //  display title at center
                pdf.setFontSize(16);
                pdf.text('Assets List', 148, 15, { align: 'center' });
                
                // display date to pdf at center
                pdf.setFontSize(10);
                pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 148, 22, { align: 'center' });
                
                const headers = ['Asset Tag', 'Name', 'Category', 'Serial Number', 'Purchase Date', 'Purchase Cost', 'Status', 'Assigned To'];
                const data = [];
                
                const table = document.getElementById('assetsTable');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        const rowData = [];
                        cells.forEach((cell, index) => {
                            if (index === 1) {
                                const link = cell.querySelector('a');
                                rowData.push(link ? link.textContent.trim() : cell.textContent.trim());
                            } else if (index === 6) {
                                const badge = cell.querySelector('.badge');
                                rowData.push(badge ? badge.textContent.trim() : cell.textContent.trim());
                            } else {
                                rowData.push(cell.textContent.trim());
                            }
                        });
                        data.push(rowData);
                    }
                });
                
                // Generate table using jsPDF autoTable plugin
                if (window.jspdf && pdf.autoTable) {
                  pdf.autoTable({
                    head: [headers],
                    body: data,
                    startY: 30,
                    styles: { 
                      fontSize: 8,
                      cellPadding: 2
                    },
                    headStyles: { 
                      fillColor: [66, 139, 202],
                      textColor: 255,
                      fontStyle: 'bold'
                    },
                    bodyStyles: {
                      textColor: 0
                    },
                    margin: { left: 10, right: 10 },
                    pageBreak: 'auto',
                    columnStyles: {
                      0: { cellWidth: 20 },
                      1: { cellWidth: 30 }, 
                      2: { cellWidth: 25 }, 
                      3: { cellWidth: 25 },
                      4: { cellWidth: 20 },
                      5: { cellWidth: 20 }, 
                      6: { cellWidth: 20 },
                      7: { cellWidth: 35 } 
                    }
                  });
                } else {
                  let yPosition = 30;
                  const cellWidths = [20, 30, 25, 25, 20, 20, 20, 35];
                  const cellHeight = 8;
                  
                  headers.forEach((header, index) => {
                    pdf.setFontSize(8);
                    pdf.text(header, 10 + cellWidths.slice(0, index).reduce((a, b) => a + b, 0), yPosition);
                  });
                  yPosition += cellHeight;
                  
                  data.forEach(row => {
                    if (yPosition > 180) { 
                      pdf.addPage();
                      yPosition = 20;
                    }
                    row.forEach((cell, index) => {
                      pdf.setFontSize(7);
                      const text = String(cell).substring(0, 25); // Limit text length
                      pdf.text(text, 10 + cellWidths.slice(0, index).reduce((a, b) => a + b, 0), yPosition);
                    });
                    yPosition += cellHeight;
                  });
                }
                
                // Save the PDF
                pdf.save('assets_export.pdf');
                
              } else if (exportType === 'csv') {
                window.location.href = table.button().add(0, {
                  extend: 'csv',
                  filename: 'assets_export',
                  title: 'Assets List'
                }).trigger();
                
              } else if (exportType === 'excel') {
                window.location.href = table.button().add(0, {
                  extend: 'excel',
                  filename: 'assets_export',
                  title: 'Assets List'
                }).trigger();
              }
            });
          });

          // Function to handle asset deletion
          function deleteAsset(assetId, deleteBtn) {
            // Show loading state
            const originalContent = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Send delete request with proper headers
            fetch(`/assets/${assetId}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
              },
              credentials: 'same-origin'
            })
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => { 
                  throw new Error(err.message || 'Failed to delete asset');
                });
              }
              return response.json();
            })
            .then(data => {
              if (data.success) {
                // Remove the row from the table with animation
                const row = deleteBtn.closest('tr');
                if (row) {
                  row.style.transition = 'opacity 0.3s';
                  row.style.opacity = '0';
                  setTimeout(() => row.remove(), 300);
                }
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                  <i class="fas fa-check-circle me-2"></i>
                  Asset deleted successfully
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                const container = document.querySelector('.container-fluid');
                if (container) {
                  container.insertBefore(alertDiv, container.firstChild);
                  
                  // Auto-hide after 5 seconds
                  setTimeout(() => {
                    const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                    if (alert) alert.close();
                  }, 5000);
                }
              } else {
                throw new Error(data.message || 'Failed to delete asset');
              }
            })
            .catch(error => {
              console.error('Delete error:', error);
              
              // Show error message
              const alertDiv = document.createElement('div');
              alertDiv.className = 'alert alert-danger alert-dismissible fade show';
              alertDiv.role = 'alert';
              alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${error.message || 'Error deleting asset. Please try again.'}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              `;
              
              const container = document.querySelector('.container-fluid');
              if (container) {
                container.insertBefore(alertDiv, container.firstChild);
              }
              
              // Reset button state
              deleteBtn.disabled = false;
              deleteBtn.innerHTML = originalContent;
            });
          }

          // Delete asset modal handler
          document.querySelectorAll('.delete-asset').forEach(button => {
            button.addEventListener('click', function(e) {
              e.preventDefault();
              const assetId = this.dataset.id;
              const deleteBtn = this;
              
              // Set up the modal
              const modal = new bootstrap.Modal(document.getElementById('deleteAssetModal'));
              
              // Set up the confirm button
              const confirmBtn = document.getElementById('confirmDelete');
              
              // Store the current state
              const originalContent = deleteBtn.innerHTML;
              
              // Create a one-time event listener for the confirm button
              const handleConfirm = () => {
                // Remove the event listener to prevent multiple triggers
                confirmBtn.removeEventListener('click', handleConfirm);
                // Call the delete function
                deleteAsset(assetId, deleteBtn);
                // Hide the modal
                modal.hide();
              };
              
              // Add the event listener
              confirmBtn.addEventListener('click', handleConfirm);
              
              // Show the modal
              modal.show();
              
              // Clean up event listeners when modal is hidden
              const onModalHidden = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                modal._element.removeEventListener('hidden.bs.modal', onModalHidden);
              };
              
              modal._element.addEventListener('hidden.bs.modal', onModalHidden);
            });
          });
        });
