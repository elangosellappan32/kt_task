extends ../layout

block content
  .container-fluid.px-4
    .d-flex.justify-content-between.align-items-center.mb-4
      h1.mb-0 Asset Categories
      a.btn.btn-primary(href='/asset-categories/add')
        i.fas.fa-plus.me-2
        | Add Category
    
    // Asset Category table
    .card
      .card-body
        .table-responsive
          table#categoriesTable.table.table-striped.table-hover
            thead
              tr
                th Category Name
                th Description
                th Lifespan (months)
                th Depreciation Rate
                th Status
                th Actions
            tbody
              each category in categories
                tr
                  td
                    strong= category.name
                  td= category.description || '—'
                  td= category.expected_lifespan_months || '—'
                  td= category.depreciation_rate ? `${category.depreciation_rate}%` : '—'
                  td
                    span.badge.rounded-pill(class=category.is_active ? 'bg-success' : 'bg-secondary')
                      = category.is_active ? 'Active' : 'Inactive'
                  td
                    .btn-group.btn-group-sm
                      // Edit category button
                      a.btn.btn-outline-primary(href=`/asset-categories/edit/${category.id}` title='Edit')
                        i.fas.fa-edit
                      // Delete category button
                      button.btn.btn-outline-danger.delete-category(type='button', data-id=category.id, title='Delete')
                        i.fas.fa-trash
    
    #deleteCategoryModal.modal.fade(tabindex='-1')
      .modal-dialog
        .modal-content
          .modal-header.bg-danger.text-white
            h5.modal-title Confirm Deletion
            button.btn-close.btn-close-white(type='button', data-bs-dismiss='modal')
          .modal-body
            p Are you sure you want to delete this asset category?
            p.text-danger This action cannot be undone.
          .modal-footer
            // Cancel button
            button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
            // Confirm delete 
            button#confirmDelete.btn.btn-danger(type='button') Delete

block scripts
  script.
    // Wait untill page load for javascript started 
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize DataTable 
      if (!$.fn.DataTable.isDataTable('#categoriesTable')) {
        $('#categoriesTable').DataTable({
          pageLength: 25  
        });
      }
      
      // Delete category functions
      document.querySelectorAll('.delete-category').forEach(button => {
        button.addEventListener('click', function() {
          const categoryId = this.dataset.id;  
          console.log('Deleting category:', categoryId);  
          
          const originalContent = this.innerHTML;
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    fetch(`/asset-categories/${categoryId}`)
            .then(response => {
              console.log('Response status:', response.status);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(category => {
              console.log('Category data:', category);
              
              this.disabled = false;
              this.innerHTML = originalContent;
              
              if (category.assets && category.assets.length > 0) {
                showAssetWarningModal(category);
              } else {
                showDeleteConfirmationModal(categoryId, category.name);
              }
            })
            .catch(error => {
              console.error('Error checking category assets:', error);
              // Restore button sate
              this.disabled = false;
              this.innerHTML = originalContent;
              showErrorAlert('Error checking category assets. Please try again.');
            });
        });
      });
      
      // display warning modal
      function showAssetWarningModal(category) {
        const assetCount = category.assets.length;
        const assetList = category.assets.map(asset => 
          `<li>${asset.name} (${asset.asset_tag})</li>`
        ).join('');
        
        const modalHtml = `
          <div class="modal fade" id="warningModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                  <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Category Has Assets
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="alert alert-warning">
                    <strong>This category contains ${assetCount} asset(s).</strong>
                  </div>
                  <p>You cannot delete a category that still has assets assigned to it.</p>
                  <p>To proceed with deletion, you must first:</p>
                  <ol>
                    <li>Reassign these assets to another category, OR</li>
                    <li>Delete these assets from the system</li>
                  </ol>
                  <div class="mt-3">
                    <strong>Assets in this category:</strong>
                    <ul class="list-group list-group-flush mt-2">
                      ${assetList}
                    </ul>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>I Understand
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Remove any existing warning modal
        const existingWarning = document.getElementById('warningModal');
        if (existingWarning) existingWarning.remove();
        
        // add extra modal to display in the page 
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const warningModal = new bootstrap.Modal(document.getElementById('warningModal'));
        warningModal.show();
        
        // Clean up modal
        document.getElementById('warningModal').addEventListener('hidden.bs.modal', function() {
          this.remove();
        });
      }
      
      //display delete confirmation modal
      function showDeleteConfirmationModal(categoryId, categoryName) {
        document.querySelector('#deleteCategoryModal .modal-body p').innerHTML = 
          `Are you sure you want to delete the asset category <strong>"${categoryName}"</strong>?<br>
           <span class="text-danger">This action cannot be undone.</span>`;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteCategoryModal'));
        
        document.getElementById('confirmDelete').onclick = function() {
          performCategoryDeletion(categoryId, modal);
        };
        
        modal.show();
      }
      
      // perform the actual deletion
      function performCategoryDeletion(categoryId, modal) {
        const deleteBtn = document.querySelector(`[data-id="${categoryId}"]`);
        const originalContent = deleteBtn.innerHTML;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        
        // Disable confirm button
        const confirmBtn = document.getElementById('confirmDelete');
        const originalConfirmContent = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        
        // Send delete request to server to remove category
        console.log('Sending DELETE request to:', `/asset-categories/${categoryId}`);
        fetch(`/asset-categories/${categoryId}`, {  
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          console.log('Delete response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Delete response data:', data);
          
          // Restore button
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = originalContent;
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = originalConfirmContent;
          
          //check deletion for confirmation
          if (data.success) {
            modal.hide();
            const row = deleteBtn.closest('tr');
            row.style.transition = 'opacity 0.3s';
            row.style.opacity = '0';
            setTimeout(() => {
              row.remove();
              showSuccessAlert('Category deleted successfully');
              $('#categoriesTable').DataTable().draw(); //refresh datatable
            }, 300);
          } else {
            showErrorAlert(data.message || 'Error deleting category');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = originalContent;
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = originalConfirmContent;
          showErrorAlert('Error deleting category. Please try again.');
        });
      }
      
      // Function to display success alert
      function showSuccessAlert(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `
          <i class="fas fa-check-circle me-2"></i>${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').prepend(alert);
        // Auto-hide success message
        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 5000);
      }
      
      // Function to show error alert
      function showErrorAlert(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `
          <i class="fas fa-exclamation-triangle me-2"></i>${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').prepend(alert);
        // Auto-hide error 
        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 8000);
      }
    });
